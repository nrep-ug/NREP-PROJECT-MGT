import { NextResponse } from 'next/server';

// Define route patterns
// Staff-only routes - clients attempting to access these will be redirected to /client/dashboard
const staffOnlyRoutes = [
  '/admin',           // Admin panel and all sub-routes
  '/dashboard',       // Staff dashboard
  '/projects',        // Project management (staff view)
  '/clients',         // Client management
  '/timesheets',      // Timesheet management
];

// Client-only routes - staff attempting to access these will be redirected to /dashboard
const clientOnlyRoutes = [
  '/client',          // Client portal and all sub-routes
];

// Public routes accessible to everyone
const publicRoutes = [
  '/',                // Home page
  '/login',           // Login page
  '/logout',          // Logout page
  '/auth',            // Auth callbacks (invitations, etc.)
  '/api',             // API routes (protected at API level)
  '/_next',           // Next.js internals
  '/favicon.ico',     // Static files
];

export async function middleware(request) {
  const { pathname } = request.nextUrl;

  // Skip middleware for static files
  if (pathname.includes('.')) {
    return NextResponse.next();
  }

  // Skip middleware for specific public routes (exact match or startsWith for paths like /api, /_next)
  const isPublicRoute = publicRoutes.some(route => {
    if (route === '/') {
      return pathname === '/'; // Exact match for home page
    }
    return pathname.startsWith(route);
  });

  if (isPublicRoute) {
    return NextResponse.next();
  }

  try {
    // Get user session info from Appwrite
    const appwriteEndpoint = process.env.NEXT_PUBLIC_APPWRITE_ENDPOINT;
    const appwriteProjectId = process.env.NEXT_PUBLIC_APPWRITE_PROJECT_ID;

    if (!appwriteEndpoint || !appwriteProjectId) {
      console.error('[Middleware] Missing Appwrite config');
      return NextResponse.next();
    }

    // Appwrite uses cookie name format: a_session_<project_id> or fallback formats
    // Try to find any Appwrite session cookie
    let sessionCookie = request.cookies.get(`a_session_${appwriteProjectId}`);

    if (!sessionCookie) {
      // Try alternative cookie names
      sessionCookie = request.cookies.get('a_session_console');
      if (!sessionCookie) {
        sessionCookie = request.cookies.get('appwrite-session');
      }
    }

    if (!sessionCookie) {
      // No session - redirect to login if not already there
      if (!pathname.startsWith('/login')) {
        console.log('[Middleware] No session cookie found, redirecting to login');
        return NextResponse.redirect(new URL('/login', request.url));
      }
      return NextResponse.next();
    }

    console.log('[Middleware] Found session cookie:', sessionCookie.name);

    // Call Appwrite API directly to get user info
    const response = await fetch(`${appwriteEndpoint}/account`, {
      headers: {
        'X-Appwrite-Project': appwriteProjectId,
        'Cookie': `${sessionCookie.name}=${sessionCookie.value}`,
      },
    });

    if (!response.ok) {
      // Invalid session - redirect to login
      console.log('[Middleware] Invalid session, response status:', response.status);
      if (!pathname.startsWith('/login')) {
        return NextResponse.redirect(new URL('/login', request.url));
      }
      return NextResponse.next();
    }

    const userData = await response.json();
    const labels = userData.labels || [];

    // Determine user role from labels
    const isAdmin = labels.includes('admin');
    const isStaff = labels.includes('staff') || isAdmin;
    const isClient = labels.includes('client');

    // Debug logging (can be removed in production)
    console.log(`[Middleware] ${pathname} - User: ${userData.email}, isClient: ${isClient}, isStaff: ${isStaff}`);

    // Check if client is trying to access staff-only routes
    if (isClient && staffOnlyRoutes.some(route => pathname.startsWith(route))) {
      console.log(`[Middleware] Redirecting client from ${pathname} to /client/dashboard`);
      return NextResponse.redirect(new URL('/client/dashboard', request.url));
    }

    // Check if staff is trying to access client-only routes
    if (isStaff && clientOnlyRoutes.some(route => pathname.startsWith(route))) {
      console.log(`[Middleware] Redirecting staff from ${pathname} to /dashboard`);
      return NextResponse.redirect(new URL('/dashboard', request.url));
    }

    return NextResponse.next();
  } catch (error) {
    console.error('[Middleware] Error:', error);
    console.error('[Middleware] Error details:', error.message, error.stack);

    // On error, allow request to continue to avoid breaking the app
    // This ensures that temporary network issues or API errors don't lock users out
    return NextResponse.next();
  }
}

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     */
    '/((?!_next/static|_next/image|favicon.ico).*)',
  ],
};
